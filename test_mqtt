
import RPi.GPIO as GPIO
import time, json, ssl
import paho.mqtt.client as mqtt
import time

GPIO.setmode(GPIO.BCM)
LED=21
GPIO.setup(LED,GPIO.OUT)

ENDPOINT = 'a248ldd9ifwiok-ats.iot.us-west-2.amazonaws.com'
THING_NAME = 'yoon-iot'

def on_connect(mqttc, obj, flags, rc):
    if rc == 0: # 연결 
        GPIO.output(LED,1)
        time.sleep(0.1)
        GPIO.output(LED,0)
        time.sleep(0.1)
        print('connected!!')
        mqttc.subscribe('test/2', qos=0) # 구독
def on_message(mqttc, obj, msg):
    if msg.topic == 'test2':
        payload = msg.payload.decode('utf-8')
        j = json.loads(payload)
        print(j['message'])

mqtt_client = mqtt.Client(client_id=THING_NAME)
mqtt_client.on_connect = on_connect
mqtt_client.on_message = on_message

mqtt_client.tls_set('/home/pi/test/root.pem', certfile='/home/pi/test/bf6881d538-certificate.pem.crt',
    keyfile='/home/pi/test/bf6881d538-private.pem.key', tls_version=ssl.PROTOCOL_TLSv1_2, ciphers=None)
mqtt_client.connect(ENDPOINT, port=8883)
mqtt_client.loop_start() # threaded network loop

